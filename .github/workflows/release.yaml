name: release jobs
on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  release:
    strategy:
      matrix:
        options:
          - make_command: all test install ARGS=-V
            cmake_extra_vars: -DBOOST_STATIC=ON
          - make_command: all test install ARGS=-V
            leatherman_pkg_suffix: "-dynamic"
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v3
      - name: run_make
        run: |
          docker run -v `pwd`:/cpp-hocon gcr.io/cpp-projects/cpp-ci:1 /bin/bash -c "
          wget https://github.com/puppetlabs/leatherman/releases/download/1.5.2/leatherman${{ matrix.options.leatherman_pkg_suffix }}.tar.gz &&
          tar xzvf leatherman${{ matrix.options.leatherman_pkg_suffix }}.tar.gz --strip 1 -C / &&
          cd /cpp-hocon &&
          cmake ${{ matrix.options.cmake_extra_vars }} . &&
          mkdir dest &&
          make ${{ matrix.options.make_command }} DESTDIR=/cpp-hocon/dest VERBOSE=1 -j2 &&
          { [[ '${{ matrix.options.coveralls }}' != 'ON' ]] || coveralls --gcov-options '\-lp' -r . -b . -e src -e vendor >/dev/null || true; }
          "
      - name: build_release_artifact_for_tags
        if: startsWith(github.ref, 'refs/tags/')
        run: tar czvf cpp-hocon${{ matrix.options.leatherman_pkg_suffix }}.tar.gz `find dest -type f -print`
      - name: upload_release_artifacts_for_tag
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: cpp-hocon${{ matrix.options.leatherman_pkg_suffix }}.tar.gz
 
